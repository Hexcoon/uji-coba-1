<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Live - Komoditas Indonesia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html"><i class="fas fa-chart-line me-2"></i>KPDI 2025</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Beranda</a></li>
                    <li class="nav-item"><a class="nav-link active" href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="kontrak.html">Kontrak Digital</a></li>
                    <li class="nav-item"><a class="nav-link" href="lapor.html">Lapor Harga</a></li>
                    <li class="nav-item"><a class="nav-link" href="tentang.html">Tentang</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <div>
                <h4 class="fw-bold mb-0 text-primary">Dashboard Monitoring</h4>
                <small class="text-muted">Data Real-time Simulasi Pasar Nasional</small>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-danger p-2 d-flex align-items-center"><span class="live-indicator me-2"></span> LIVE MARKET</span>
                <button id="downloadData" class="btn btn-outline-primary btn-sm"><i class="fas fa-download me-2"></i>Export Excel</button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card p-3">
                    <label class="form-label fw-bold text-muted small">PILIH KOMODITAS PANGAN</label>
                    <select id="commoditySelect" class="form-select form-select-lg border-primary fw-bold">
                        <option value="beras">Beras Premium</option>
                        <option value="cabai">Cabai Merah Keriting</option>
                        <option value="bawang">Bawang Merah</option>
                        <option value="minyak">Minyak Goreng</option>
                        <option value="gula">Gula Pasir</option>
                        <option value="telur">Telur Ayam Ras</option>
                        <option value="daging">Daging Ayam</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 text-center bg-dark text-white h-100 d-flex justify-content-center flex-column">
                    <small class="text-white-50">HARGA LIVE SAAT INI</small>
                    <h2 class="fw-bold mb-0" id="livePriceTicker">Rp 0</h2>
                    <small id="livePriceChange" class="text-white-50">--</small>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card p-3 border-start border-4 border-warning">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3"><i class="fas fa-cloud-sun text-warning fa-2x"></i></div>
                        <div><small class="text-muted fw-bold">CUACA</small><h6 class="mb-0 fw-bold" id="weatherFactor">...</h6></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 border-start border-4 border-info">
                    <div class="d-flex align-items-center">
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle me-3"><i class="fas fa-warehouse text-info fa-2x"></i></div>
                        <div><small class="text-muted fw-bold">STOK GUDANG</small><h6 class="mb-0 fw-bold" id="stockFactor">...</h6></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 border-start border-4 border-success">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3"><i class="fas fa-truck text-success fa-2x"></i></div>
                        <div><small class="text-muted fw-bold">DISTRIBUSI</small><h6 class="mb-0 fw-bold" id="distributionFactor">...</h6></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-lg-8">
                <div class="card p-3 h-100">
                    <h5 class="fw-bold mb-3"><i class="fas fa-robot me-2 text-primary"></i>Proyeksi AI (30 Hari Kedepan)</h5>
                    <div style="height: 350px;"><canvas id="predictionChart"></canvas></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card p-3 h-100">
                    <h5 class="fw-bold mb-3"><i class="fas fa-history me-2 text-success"></i>Tren Historis</h5>
                    <div style="height: 350px;"><canvas id="historicalChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="card p-4 mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold m-0"><i class="fas fa-newspaper me-2 text-danger"></i>Kabar Pangan Terkini</h5>
                <span class="badge bg-secondary">Update: Hari Ini</span>
            </div>
            <div class="row g-3" id="newsContainer"></div>
        </div>
    </main>

    <footer class="text-center">
        <div class="container"><p class="mb-0 small">&copy; 2025 Komoditas Indonesia. All rights reserved.</p></div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        $(document).ready(function() {
            // 1. DATASET PINTAR
            const db = {
                beras: { base: 13500, min: 13000, max: 14000, f: {w:"Cerah (Panen Raya)", s:"Surplus 15%", d:"Lancar Jaya"} },
                cabai: { base: 45000, min: 35000, max: 55000, f: {w:"Hujan Ekstrem", s:"Menipis", d:"Terhambat"} },
                bawang: { base: 32000, min: 28000, max: 38000, f: {w:"Berawan", s:"Cukup", d:"Normal"} },
                minyak: { base: 15000, min: 14000, max: 16000, f: {w:"Normal", s:"Aman (DMO)", d:"Operasi Pasar"} },
                gula: { base: 17000, min: 16000, max: 18000, f: {w:"Kering", s:"Impor Masuk", d:"Lancar"} },
                telur: { base: 29000, min: 27000, max: 32000, f: {w:"Panas", s:"Pakan Mahal", d:"Stabil"} },
                daging: { base: 38000, min: 35000, max: 42000, f: {w:"Normal", s:"Stabil", d:"Lancar"} }
            };

            let pChart, hChart, liveInterval;
            let currentPrice = 0;

            // 2. LIVE SIMULATION LOGIC
            function startLiveTicker(commodity) {
                clearInterval(liveInterval);
                let price = db[commodity].base;
                currentPrice = price;
                
                // Update pertama
                updateTickerDisplay(price, 0);

                // Update tiap 3 detik (Efek Live Trade)
                liveInterval = setInterval(() => {
                    const change = Math.floor(Math.random() * 200) - 100; // Fluktuasi -100 smp +100
                    const newPrice = currentPrice + change;
                    updateTickerDisplay(newPrice, change);
                    currentPrice = newPrice;
                }, 3000);
            }

            function updateTickerDisplay(price, change) {
                const elPrice = $('#livePriceTicker');
                const elChange = $('#livePriceChange');
                
                elPrice.text(`Rp ${price.toLocaleString('id-ID')}`);
                
                if(change > 0) {
                    elPrice.removeClass('price-down').addClass('price-up');
                    elChange.html(`<i class="fas fa-caret-up"></i> +${change}`).removeClass('text-danger').addClass('text-success');
                } else if(change < 0) {
                    elPrice.removeClass('price-up').addClass('price-down');
                    elChange.html(`<i class="fas fa-caret-down"></i> ${change}`).removeClass('text-success').addClass('text-danger');
                }
                
                // Remove animation class after 1s
                setTimeout(() => elPrice.removeClass('price-up price-down'), 1000);
            }

            // 3. CHART & DATA LOADER
            function loadData(comm) {
                const d = db[comm];
                $('#weatherFactor').text(d.f.w);
                $('#stockFactor').text(d.f.s);
                $('#distributionFactor').text(d.f.d);

                // Start Live Ticker
                startLiveTicker(comm);

                // Data Generation
                const labels = Array.from({length:30}, (_,i)=>`H-${30-i}`);
                const pLabels = Array.from({length:30}, (_,i)=>`H+${i+1}`);
                
                const hData = Array.from({length:30}, () => d.base + Math.floor(Math.random() * 1000 - 500));
                const pData = Array.from({length:30}, () => d.base + Math.floor(Math.random() * 2000 - 1000));

                // Render Charts
                if(pChart) pChart.destroy();
                if(hChart) hChart.destroy();

                // Prediksi Chart (Line)
                const ctxP = document.getElementById('predictionChart').getContext('2d');
                let grad = ctxP.createLinearGradient(0,0,0,400);
                grad.addColorStop(0, 'rgba(13, 110, 253, 0.2)');
                grad.addColorStop(1, 'rgba(13, 110, 253, 0)');

                pChart = new Chart(ctxP, {
                    type: 'line',
                    data: { labels: pLabels, datasets: [{ label:'AI Forecast', data:pData, borderColor:'#0d6efd', backgroundColor:grad, fill:true, tension:0.4 }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, interaction:{intersect:false, mode:'index'} }
                });

                // Historis Chart (Bar)
                hChart = new Chart(document.getElementById('historicalChart'), {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label:'Realisasi', data:hData, backgroundColor:'#198754', borderRadius:2 }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
                });
            }

            // 4. BERITA (Icon Based - Anti Broken)
            const news = [
                {t:"Stok Beras Nasional Aman 6 Bulan", s:"Bapanas", i:"fa-bowl-rice", c:"bg-success"},
                {t:"Operasi Pasar Minyak Goreng Murah", s:"Info Pangan", i:"fa-bottle-droplet", c:"bg-warning"},
                {t:"Panen Raya Cabai di Jawa Timur", s:"Pertanian", i:"fa-pepper-hot", c:"bg-danger"},
                {t:"Digitalisasi Rantai Pasok Telur", s:"Teknologi", i:"fa-egg", c:"bg-info"}
            ];
            
            $('#newsContainer').html(news.map(n => `
                <div class="col-md-3">
                    <div class="card h-100 border shadow-sm">
                        <div class="${n.c} text-white d-flex align-items-center justify-content-center" style="height: 100px;">
                            <i class="fas ${n.i} fa-3x opacity-75"></i>
                        </div>
                        <div class="card-body p-3">
                            <span class="badge bg-light text-dark border mb-2">${n.s}</span>
                            <h6 class="fw-bold text-dark" style="font-size: 14px;">${n.t}</h6>
                        </div>
                    </div>
                </div>`).join(''));

            // Events
            $('#commoditySelect').change(function(){ loadData(this.value); });
            $('#downloadData').click(function(){ 
                Swal.fire({title:'Mengunduh Excel...', timer:1500, didOpen:()=>Swal.showLoading()}).then(()=>Swal.fire('Sukses', 'Laporan tersimpan.', 'success')); 
            });

            // Init
            loadData('beras');
        });
    </script>
</body>
</html>